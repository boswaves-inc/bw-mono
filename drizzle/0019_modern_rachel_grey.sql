DROP VIEW "public"."cart_data";--> statement-breakpoint
CREATE VIEW "public"."cart_data" AS (select "cart_info"."id", "cart_info"."uid", json_agg(json_build_object('id', "script_data"."id", 'uuid', "script_data"."uuid", 'type', "script_data"."type", 'name', "script_data"."name", 'slug', "script_data"."slug", 'status', "script_data"."status", 'image', "script_data"."image", 'description', "script_data"."description", 'created_at', "script_data"."created_at", 'updated_at', "script_data"."updated_at", 'archived_at', "script_data"."archived_at")) FILTER (WHERE "cart_item"."item_tpe" = 'script') as "items", coalesce(json_agg(json_build_object('id', "coupon_data"."id", 'name', "coupon_data"."name", 'status', "coupon_data"."status", 'type', "coupon_data"."type", 'value', "coupon_data"."value", 'apply_on', "coupon_data"."apply_on", 'created_at', "coupon_data"."created_at", 'updated_at', "coupon_data"."updated_at", 'archived_at', "coupon_data"."archived_at")) FILTER (WHERE "cart_item"."item_tpe" = 'coupon'), '[]'::json) as "coupons", "cart_info"."created_at", max("cart_item"."updated_at") as "updated_at" from "cart_info" inner join "cart_item" on "cart_item"."cart_id" = "cart_info"."id" left join "script_data" on "cart_item"."item_id" = "script_data"."id" left join "coupon_data" on "cart_item"."item_id" = "coupon_data"."id" group by "cart_info"."id");