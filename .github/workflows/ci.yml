name: CI

on:
    pull_request:
        branches: [main]
    push:
        branches: [main]

permissions:
  contents: read
  pull-requests: read

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

jobs:
    scope:
        runs-on: ubuntu-latest
        outputs:
            smtp: ${{ steps.scope.outputs.smtp }}
            webstore: ${{ steps.scope.outputs.webstore }}
        steps:
            - uses: actions/checkout@v4
            - id: scope
              uses: ./.github/actions/scope

    ci-smtp:
        name: CI SMTP
        needs: scope
        runs-on: ubuntu-latest
        if: needs.scope.outputs.smtp == 'true'
        steps:
            - uses: actions/checkout@v4
            - uses: ./.github/actions/node
            - run: pnpm run build:smtp

    ci-webstore:
        name: CI Webstore
        needs: scope
        runs-on: ubuntu-latest
        if: needs.scope.outputs.webstore == 'true'
        steps:
            - uses: actions/checkout@v4
            - uses: ./.github/actions/node
            - run: pnpm run build:webstore

    ci-ok:
        name: CI OK
        if: always()
        runs-on: ubuntu-latest
        needs: [scope, ci-smtp, ci-webstore]
        steps:
            - name: Check CI status
              shell: bash
              run: |
                  set -euo pipefail
                  if [[ "${{ needs.ci-smtp.result }}" =~ ^(failure|cancelled)$ ]] || \
                     [[ "${{ needs.ci-webstore.result }}" =~ ^(failure|cancelled)$ ]]; then
                    echo "CI failed"
                    exit 1
                  fi
                  echo "CI passed"
