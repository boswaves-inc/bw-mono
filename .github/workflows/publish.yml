name: Publish

on:
    workflow_run:
        workflows: [CI]
        branches: [main]
        types: [completed]

permissions:
    contents: read
    packages: write

jobs:
    scope:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            pull-requests: read
        if: github.event.workflow_run.conclusion == 'success'
        outputs:
            smtp: ${{ steps.scope.outputs.smtp }}
            webstore: ${{ steps.scope.outputs.webstore }}
        steps:
            - uses: actions/checkout@v4

            - id: scope
              uses: ./.github/actions/scope

    publish-smtp:
        needs: scope
        runs-on: ubuntu-latest
        if: needs.scope.outputs.smtp == 'true'
        steps:
            - uses: actions/checkout@v4
              with:
                  ref: ${{ github.event.workflow_run.head_sha }}

            - uses: ./.github/actions/docker
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  context: ./services/smtp
                  image: boswaves-inc/smtp

    publish-webstore:
        needs: scope
        runs-on: ubuntu-latest
        if: needs.scope.outputs.webstore == 'true'
        steps:
            - uses: actions/checkout@v4
              with:
                  ref: ${{ github.event.workflow_run.head_sha }}

            - uses: ./.github/actions/docker
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  context: ./services/webstore
                  image: boswaves-inc/webstore
